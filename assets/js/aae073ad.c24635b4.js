"use strict";(self.webpackChunkairsdk_dev=self.webpackChunkairsdk_dev||[]).push([[31950],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),c=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=c(e.components);return a.createElement(p.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},y=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=c(n),y=r,u=d["".concat(p,".").concat(y)]||d[y]||h[y]||o;return n?a.createElement(u,i(i({ref:t},l),{},{components:n})):a.createElement(u,i({ref:t},l))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=y;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}y.displayName="MDXCreateElement"},40310:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={sidebar_position:5},i="Using encryption with SQL databases",s={unversionedId:"development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases",id:"development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases",title:"Using encryption with SQL databases",description:"All Adobe AIR applications share the same local database engine. Consequently,",source:"@site/docs/development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases.md",sourceDirName:"development/files-and-data/working-with-local-sql-databases-in-air",slug:"/development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases",permalink:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases",draft:!1,editUrl:"https://github.com/airsdk/airsdk.dev/edit/main/docs/development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"mainSidebar",previous:{title:"Understanding the asynchronous execution model",permalink:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/using-synchronous-and-asynchronous-database-operations/understanding-the-asynchronous-execution-model"},next:{title:"Strategies for working with SQL databases",permalink:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/strategies-for-working-with-sql-databases"}},p={},c=[{value:"Uses for an encrypted database",id:"uses-for-an-encrypted-database",level:2},{value:"Creating an encrypted database",id:"creating-an-encrypted-database",level:2},{value:"Connecting to an encrypted database",id:"connecting-to-an-encrypted-database",level:2},{value:"Changing the encryption key of a database",id:"changing-the-encryption-key-of-a-database",level:2},{value:"Considerations for using encryption with a database",id:"considerations-for-using-encryption-with-a-database",level:2},{value:"Example: Generating and using an encryption key",id:"example-generating-and-using-an-encryption-key",level:2},{value:"Using the EncryptionKeyGenerator class to obtain a secure encryption key",id:"using-the-encryptionkeygenerator-class-to-obtain-a-secure-encryption-key",level:3},{value:"Complete example code for generating and using an encryption key",id:"complete-example-code-for-generating-and-using-an-encryption-key",level:3},{value:"Flex example",id:"flex-example",level:4},{value:"Flash Professional example",id:"flash-professional-example",level:4},{value:"Understanding the EncryptionKeyGenerator class",id:"understanding-the-encryptionkeygenerator-class",level:3},{value:"Obtain and validate a strong password",id:"obtain-and-validate-a-strong-password",level:4},{value:"Expand the password to 256 bits",id:"expand-the-password-to-256-bits",level:4},{value:"Generate or retrieve a 256-bit salt value",id:"generate-or-retrieve-a-256-bit-salt-value",level:4},{value:"Combine the 256-bit password and salt using the XOR operator",id:"combine-the-256-bit-password-and-salt-using-the-xor-operator",level:4},{value:"Hash the key",id:"hash-the-key",level:4},{value:"Extract the encryption key from the hash",id:"extract-the-encryption-key-from-the-hash",level:4}],l={toc:c},d="wrapper";function h(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"using-encryption-with-sql-databases"},"Using encryption with SQL databases"),(0,r.kt)("p",null,"All Adobe AIR applications share the same local database engine. Consequently,\nany AIR application can connect to, read from, and write to an unencrypted\ndatabase file. Starting with Adobe AIR 1.5, AIR includes the capability of\ncreating and connecting to encrypted database files. When you use an encrypted\ndatabase, in order to connect to the database an application must provide the\ncorrect encryption key. If the incorrect encryption key (or no key) is provided,\nthe application is not able to connect to the database. Consequently, the\napplication can't read data from the database or write to or change data in the\ndatabase."),(0,r.kt)("p",null,"To use an encrypted database, you must create the database as an encrypted\ndatabase. With an existing encrypted database, you can open a connection to the\ndatabase. You can also change the encryption key of an encrypted database. Other\nthan creating and connecting to encrypted databases, the techniques for working\nwith an encrypted database are the same as for working with an unencrypted one.\nIn particular, executing SQL statements is the same regardless of whether a\ndatabase is encrypted or not."),(0,r.kt)("h2",{id:"uses-for-an-encrypted-database"},"Uses for an encrypted database"),(0,r.kt)("p",null,"Encryption is useful any time you want to restrict access to the information\nstored in a database. The database encryption functionality of Adobe AIR can be\nused for several purposes. The following are some examples of cases where you\nwould want to use an encrypted database:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"A read-only cache of private application data downloaded from a server")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"A local application store for private data that is synchronized with a server\n(data is sent to and loaded from the server)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Encrypted files used as the file format for documents created and edited by\nthe application. The files could be private to one user, or could be designed\nto be shared among all users of the application.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Any other use of a local data store, such as the ones described in\n",(0,r.kt)("a",{parentName:"p",href:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/about-local-sql-databases#uses-for-local-sql-databases"},"Uses for local SQL databases"),",\nwhere the data must be kept private from people who have access to the machine\nor the database files."))),(0,r.kt)("p",null,"Understanding the reason why you want to use an encrypted database helps you\ndecide how to architect your application. In particular, it can affect how your\napplication creates, obtains, and stores the encryption key for the database.\nFor more information about these considerations, see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/using-encryption-with-sql-databases#considerations-for-using-encryption-with-a-database"},"Considerations for using encryption with a database"),"."),(0,r.kt)("p",null,"Other than an encrypted database, an alternative mechanism for keeping sensitive\ndata private is the\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/EncryptedLocalStore.html"},"encrypted local store"),".\nWith the encrypted local store, you store a single\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/utils/ByteArray.html"},"ByteArray"),"\nvalue using a String key. Only the AIR application that stores the value can\naccess it, and only on the computer on which it is stored. With the encrypted\nlocal store, it isn't necessary to create your own encryption key. For these\nreasons, the encrypted local store is most suitable for easily storing a single\nvalue or set of values that can easily be encoded in a ByteArray. An encrypted\ndatabase is most suitable for larger data sets where structured data storage and\nquerying are desirable. For more information about using the encrypted local\nstore, see\n",(0,r.kt)("a",{parentName:"p",href:"/docs/development/files-and-data/storing-local-data/encrypted-local-storage"},"Encrypted local storage"),"."),(0,r.kt)("h2",{id:"creating-an-encrypted-database"},"Creating an encrypted database"),(0,r.kt)("p",null,"To use an encrypted database, the database file must be encrypted when it is\ncreated. Once a database is created as unencrypted, it can't be encrypted later.\nLikewise, an encrypted database can't be unencrypted later. If needed you can\nchange the encryption key of an encrypted database. For details, see\n",(0,r.kt)("a",{parentName:"p",href:"#changing-the-encryption-key-of-a-database"},"Changing the encryption key of a database"),".\nIf you have an existing database that's not encrypted and you want to use\ndatabase encryption, you can create a new encrypted database and copy the\nexisting table structure and data to the new database."),(0,r.kt)("p",null,"Creating an encrypted database is nearly identical to creating an unencrypted\ndatabase, as described in\n",(0,r.kt)("a",{parentName:"p",href:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/creating-and-modifying-a-database#creating-a-database"},"Creating a database"),".\nYou first create a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/SQLConnection.html"},"SQLConnection"),"\ninstance that represents the connection to the database. You create the database\nby calling the SQLConnection object's ",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," method or ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method,\nspecifying for the database location a file that doesn't exist yet. The only\ndifference when creating an encrypted database is that you provide a value for\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"encryptionKey")," parameter (the ",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," method's fifth parameter and the\n",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method's sixth parameter)."),(0,r.kt)("p",null,"A valid ",(0,r.kt)("inlineCode",{parentName:"p"},"encryptionKey")," parameter value is a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/utils/ByteArray.html"},"ByteArray"),"\nobject containing exactly 16 bytes."),(0,r.kt)("p",null,"The following examples demonstrate creating an encrypted database. For\nsimplicity, in these examples the encryption key is hard-coded in the\napplication code. However, this technique is strongly discouraged because it is\nnot secure."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'var conn:SQLConnection = new SQLConnection();\n\nvar encryptionKey:ByteArray = new ByteArray();\nencryptionKey.writeUTFBytes("Some16ByteString"); // This technique is not secure!\n\n// Create an encrypted database in asynchronous mode\nconn.openAsync(dbFile, SQLMode.CREATE, null, false, 1024, encryptionKey);\n\n// Create an encrypted database in synchronous mode\nconn.open(dbFile, SQLMode.CREATE, false, 1024, encryptionKey);\n')),(0,r.kt)("p",null,"For an example demonstrating a recommended way to generate an encryption key,\nsee\n",(0,r.kt)("a",{parentName:"p",href:"#example-generating-and-using-an-encryption-key"},"Example: Generating and using an encryption key"),"."),(0,r.kt)("h2",{id:"connecting-to-an-encrypted-database"},"Connecting to an encrypted database"),(0,r.kt)("p",null,"Like creating an encrypted database, the procedure for opening a connection to\nan encrypted database is like connecting to an unencrypted database. That\nprocedure is described in greater detail in\n",(0,r.kt)("a",{parentName:"p",href:"/docs/development/files-and-data/working-with-local-sql-databases-in-air/connecting-to-a-database"},"Connecting to a database"),". You use the ",(0,r.kt)("inlineCode",{parentName:"p"},"open()"),"\nmethod to\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/SQLConnection.html#open()"},"open a connection in synchronous execution mode"),",\nor the ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method to\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/SQLConnection.html#openAsync()"},"open a connection in asynchronous execution mode"),".\nThe only difference is that to open an encrypted database, you specify the\ncorrect value for the ",(0,r.kt)("inlineCode",{parentName:"p"},"encryptionKey")," parameter (the ",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," method's fifth\nparameter and the ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method's sixth parameter)."),(0,r.kt)("p",null,"If the encryption key that's provided is not correct, an error occurs. For the\n",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," method, a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/errors/SQLError.html"},"SQLError"),"\nexception is thrown. For the ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method, the\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/SQLConnection.html"},"SQLConnection"),"\nobject dispatches a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/events/SQLErrorEvent.html"},"SQLErrorEvent"),",\nwhose ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," property contains a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/errors/SQLError.html"},"SQLError"),"\nobject. In either case, the SQLError object generated by the exception has the\n",(0,r.kt)("inlineCode",{parentName:"p"},"errorID"),' property value 3138. That error ID corresponds to the error message\n"File opened is not a database file."'),(0,r.kt)("p",null,"The following example demonstrates opening an encrypted database in asynchronous\nexecution mode. For simplicity, in this example the encryption key is hard-coded\nin the application code. However, this technique is strongly discouraged because\nit is not secure."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'import flash.data.SQLConnection;\nimport flash.data.SQLMode;\nimport flash.events.SQLErrorEvent;\nimport flash.events.SQLEvent;\nimport flash.filesystem.File;\n\nvar conn:SQLConnection = new SQLConnection();\nconn.addEventListener(SQLEvent.OPEN, openHandler);\nconn.addEventListener(SQLErrorEvent.ERROR, errorHandler);\nvar dbFile:File = File.applicationStorageDirectory.resolvePath("DBSample.db");\n\nvar encryptionKey:ByteArray = new ByteArray();\nencryptionKey.writeUTFBytes("Some16ByteString"); // This technique is not secure!\n\nconn.openAsync(dbFile, SQLMode.UPDATE, null, false, 1024, encryptionKey);\n\nfunction openHandler(event:SQLEvent):void\n{\n    trace("the database opened successfully");\n}\n\nfunction errorHandler(event:SQLErrorEvent):void\n{\n    if (event.error.errorID == 3138)\n    {\n        trace("Incorrect encryption key");\n    }\n    else\n    {\n        trace("Error message:", event.error.message);\n        trace("Details:", event.error.details);\n    }\n}\n')),(0,r.kt)("p",null,"The following example demonstrates opening an encrypted database in synchronous\nexecution mode. For simplicity, in this example the encryption key is hard-coded\nin the application code. However, this technique is strongly discouraged because\nit is not secure."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'import flash.data.SQLConnection;\nimport flash.data.SQLMode;\nimport flash.filesystem.File;\n\nvar conn:SQLConnection = new SQLConnection();\nvar dbFile:File = File.applicationStorageDirectory.resolvePath("DBSample.db");\n\nvar encryptionKey:ByteArray = new ByteArray();\nencryptionKey.writeUTFBytes("Some16ByteString"); // This technique is not secure!\n\ntry\n{\n    conn.open(dbFile, SQLMode.UPDATE, false, 1024, encryptionKey);\n    trace("the database was created successfully");\n}\ncatch (error:SQLError)\n{\n    if (error.errorID == 3138)\n    {\n        trace("Incorrect encryption key");\n    }\n    else\n    {\n        trace("Error message:", error.message);\n        trace("Details:", error.details);\n    }\n}\n')),(0,r.kt)("p",null,"For an example demonstrating a recommended way to generate an encryption key,\nsee\n",(0,r.kt)("a",{parentName:"p",href:"#example-generating-and-using-an-encryption-key"},"Example: Generating and using an encryption key"),"."),(0,r.kt)("h2",{id:"changing-the-encryption-key-of-a-database"},"Changing the encryption key of a database"),(0,r.kt)("p",null,"When a database is encrypted, you can change the encryption key for the database\nat a later time. To change a database's encryption key, first open a connection\nto the database by creating a\n",(0,r.kt)("a",{parentName:"p",href:"https://airsdk.dev/reference/actionscript/3.0/flash/data/SQLConnection.html"},"SQLConnection"),"\ninstance and calling its ",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method. Once the database is\nconnected, call the ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," method, passing the new encryption key as an\nargument."),(0,r.kt)("p",null,"Like most database operations, the ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," method's behavior varies\ndepending on whether the database connection uses synchronous or asynchronous\nexecution mode. If you use the ",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," method to connect to the database, the\n",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," operation runs synchronously. When the operation finishes,\nexecution continues with the next line of code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var newKey:ByteArray = new ByteArray();\n// ... generate the new key and store it in newKey\nconn.reencrypt(newKey);\n")),(0,r.kt)("p",null,"On the other hand, if the database connection is opened using the ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()"),"\nmethod, the ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," operation is asynchronous. Calling ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()"),"\nbegins the reencryption process. When the operation completes, the SQLConnection\nobject dispatches a ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt")," event. You use an event listener to determine\nwhen the reencryption finishes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var newKey:ByteArray = new ByteArray();\n// ... generate the new key and store it in newKey\n\nconn.addEventListener(SQLEvent.REENCRYPT, reencryptHandler);\n\nconn.reencrypt(newKey);\n\nfunction reencryptHandler(event:SQLEvent):void\n{\n    // save the fact that the key changed\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," operation runs in its own transaction. If the operation is\ninterrupted or fails (for example, if the application is closed before the\noperation finishes) the transaction is rolled back. In that case, the original\nencryption key is still the encryption key for the database."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," method can't be used to remove encryption from a database.\nPassing a ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," value or encryption key that's not a 16-byte ByteArray to the\n",(0,r.kt)("inlineCode",{parentName:"p"},"reencrypt()")," method results in an error."),(0,r.kt)("h2",{id:"considerations-for-using-encryption-with-a-database"},"Considerations for using encryption with a database"),(0,r.kt)("p",null,"The section ",(0,r.kt)("a",{parentName:"p",href:"#uses-for-an-encrypted-database"},"Uses for an encrypted database"),"\npresents several cases in which you would want to use an encrypted database.\nIt's obvious that the usage scenarios of different applications (including these\nand other scenarios) have different privacy requirements. The way you architect\nthe use of encryption in your application plays an important part in controlling\nhow private a database's data is. For example, if you are using an encrypted\ndatabase to keep personal data private, even from other users of the same\nmachine, then each user's database needs its own encryption key. For the\ngreatest security, your application can generate the key from a user-entered\npassword. Basing the encryption key on a password ensures that even if another\nperson is able to impersonate the user's account on the machine, the data still\ncan't be accessed. On the other end of the privacy spectrum, suppose you want a\ndatabase file to be readable by any user of your application but not to other\napplications. In that case every installed copy of the application needs access\nto a shared encryption key."),(0,r.kt)("p",null,"You can design your application, and in particular the technique used to\ngenerate the encryption key, according to the level of privacy that you want for\nyour application data. The following list provides design suggestions for\nvarious levels of data privacy:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To make a database accessible to any user who has access to the application on\nany machine, use a single key that's available to all instances of the\napplication. For example, the first time an application runs it can download\nthe shared encryption key from a server using a secure protocol such as SSL.\nIt can then save the key in the encrypted local store for future use. As an\nalternative, encrypt the data per-user on the machine, and synchronize the\ndata with a remote data store such as a server to make the data portable.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To make a database accessible to a single user on any machine, generate the\nencryption key from a user secret (such as a password). In particular, do not\nuse any value that's tied to a particular computer (such as a value stored in\nthe encrypted local store) to generate the key. As an alternative, encrypt the\ndata per-user on the machine, and synchronize the data with a remote data\nstore such as a server to make the data portable.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"To make a database accessible only to a single individual on a single machine,\ngenerate the key from a password and a generated salt. For an example of this\ntechnique, see\n",(0,r.kt)("a",{parentName:"p",href:"#example-generating-and-using-an-encryption-key"},"Example: Generating and using an encryption key"),"."))),(0,r.kt)("p",null,"The following are additional security considerations that are important to keep\nin mind when designing an application to use an encrypted database:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"A system is only as secure as its weakest link. If you are using a\nuser-entered password to generate an encryption key, consider imposing minimum\nlength and complexity restrictions on passwords. A short password that uses\nonly basic characters can be guessed quickly.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The source code of an AIR application is stored on a user's machine in plain\ntext (for HTML content) or an easily decompilable binary format (for SWF\ncontent). Because the source code is accessible, two points to remember are:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Never hard-code an encryption key in your source code")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Always assume that the technique used to generate an encryption key (such as\nrandom character generator or a particular hashing algorithm) can be easily\nworked out by an attacker")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"AIR database encryption uses the Advanced Encryption Standard (AES) with\nCounter with CBC-MAC (CCM) mode. This encryption cipher requires a\nuser-entered key to be combined with a salt value to be secure. For an example\nof this, see\n",(0,r.kt)("a",{parentName:"p",href:"#example-generating-and-using-an-encryption-key"},"Example: Generating and using an encryption key"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"When you elect to encrypt a database, all disk files used by the database\nengine in conjunction with that database are encrypted. However, the database\nengine holds some data temporarily in an in-memory cache to improve read- and\nwrite-time performance in transactions. Any memory-resident data is\nunencrypted. If an attacker is able to access the memory used by an AIR\napplication, for example by using a debugger, the data in a database that is\ncurrently open and unencrypted would be available."))),(0,r.kt)("h2",{id:"example-generating-and-using-an-encryption-key"},"Example: Generating and using an encryption key"),(0,r.kt)("p",null,"This example application demonstrates one technique for generating an encryption\nkey. This application is designed to provide the highest level of privacy and\nsecurity for users' data. One important aspect of securing private data is to\nrequire the user to enter a password each time the application connects to the\ndatabase. Consequently, as shown in this example, an application that requires\nthis level of privacy should never directly store the database encryption key."),(0,r.kt)("p",null,"The application consists of two parts: an ActionScript class that generates an\nencryption key (the EncryptionKeyGenerator class), and a basic user interface\nthat demonstrates how to use that class. For the complete source code, see\n",(0,r.kt)("a",{parentName:"p",href:"#example-generating-and-using-an-encryption-key"},"Complete example code for generating and using an encryption key"),"."),(0,r.kt)("h3",{id:"using-the-encryptionkeygenerator-class-to-obtain-a-secure-encryption-key"},"Using the EncryptionKeyGenerator class to obtain a secure encryption key"),(0,r.kt)("p",null,"It isn't necessary to understand the details of how the EncryptionKeyGenerator\nclass works to use it in your application. If you are interested in the details\nof how the class generates an encryption key for a database, see\n",(0,r.kt)("a",{parentName:"p",href:"#understanding-the-encryptionkeygenerator-class"},"Understanding the EncryptionKeyGenerator class"),"."),(0,r.kt)("p",null,"Follow these steps to use the EncryptionKeyGenerator class in your application:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download the EncryptionKeyGenerator class as source code or a compiled SWC.\nThe EncryptionKeyGenerator class is included in the open-source ActionScript\n3.0 core library (as3corelib) project. You can download\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mikechambers/as3corelib"},"the as3corelib package including source code and documentation"),".\nYou can also download the SWC or source code files from the project page.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Place the source code for the EncryptionKeyGenerator class (or the\nas3corelib SWC) in a location where your application source code can find\nit.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In your application source code, add an ",(0,r.kt)("inlineCode",{parentName:"p"},"import")," statement for the\nEncryptionKeyGenerator class."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"import com.adobe.air.crypto.EncryptionKeyGenerator;\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Before the point where the code creates the database or opens a connection\nto it, add code to create an EncryptionKeyGenerator instance by calling the\n",(0,r.kt)("inlineCode",{parentName:"p"},"EncryptionKeyGenerator()")," constructor."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"var keyGenerator:EncryptionKeyGenerator = new EncryptionKeyGenerator();\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Obtain a password from the user:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"var password:String = passwordInput.text;\n\nif (!keyGenerator.validateStrongPassword(password))\n{\n    // display an error message\n    return;\n}\n")),(0,r.kt)("p",{parentName:"li"},"The EncryptionKeyGenerator instance uses this password as the basis for the\nencryption key (shown in the next step). The EncryptionKeyGenerator instance\ntests the password against certain strong password validation requirements.\nIf the validation fails, an error occurs. As the example code shows, you can\ncheck the password ahead of time by calling the EncryptionKeyGenerator\nobject's ",(0,r.kt)("inlineCode",{parentName:"p"},"validateStrongPassword()")," method. That way you can determine\nwhether the password meets the minimum requirements for a strong password\nand avoid an error.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate the encryption key from the password:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"var encryptionKey:ByteArray = keyGenerator.getEncryptionKey(password);\n")),(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method generates and returns the encryption key (a\n16-byte ByteArray). You can then use the encryption key to create your new\nencrypted database or open your existing one."),(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method has one required parameter, which is the\npassword obtained in step 5."),(0,r.kt)("p",{parentName:"li"},"Note: To maintain the highest level of security and privacy for data, an\napplication must require the user to enter a password each time the\napplication connects to the database. Do not store the user's password or\nthe database encryption key directly. Doing so exposes security risks.\nInstead, as demonstrated in this example, an application should use the same\ntechnique to derive the encryption key from the password both when creating\nthe encrypted database and when connecting to it later."),(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method also accepts a second (optional) parameter,\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"overrideSaltELSKey")," parameter. The EncryptionKeyGenerator creates a\nrandom value (known as a ",(0,r.kt)("em",{parentName:"p"},"salt")," ) that is used as part of the encryption\nkey. In order to be able to re-create the encryption key, the salt value is\nstored in the Encrypted Local Store (ELS) of your AIR application. By\ndefault, the EncryptionKeyGenerator class uses a particular String as the\nELS key. Although unlikely, it's possible that the key can conflict with\nanother key your application uses. Instead of using the default key, you\nmight want to specify your own ELS key. In that case, specify a custom key\nby passing it as the second ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," parameter, as shown here:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'var customKey:String = "My custom ELS salt key";\nvar encryptionKey:ByteArray = keyGenerator.getEncryptionKey(password, customKey);\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create or open the database"),(0,r.kt)("p",{parentName:"li"},"With an encryption key returned by the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method, your\ncode can create a new encrypted database or attempt to open the existing\nencrypted database. In either case you use the SQLConnection class's\n",(0,r.kt)("inlineCode",{parentName:"p"},"open()")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method, as described in\n",(0,r.kt)("a",{parentName:"p",href:"#creating-an-encrypted-database"},"Creating an encrypted database")," and\n",(0,r.kt)("a",{parentName:"p",href:"#connecting-to-an-encrypted-database"},"Connecting to an encrypted database"),"."),(0,r.kt)("p",{parentName:"li"},"In this example, the application is designed to open the database in\nasynchronous execution mode. The code sets up the appropriate event\nlisteners and calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"openAsync()")," method, passing the encryption key as\nthe final argument:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"conn.addEventListener(SQLEvent.OPEN, openHandler);\nconn.addEventListener(SQLErrorEvent.ERROR, openError);\n\nconn.openAsync(dbFile, SQLMode.CREATE, null, false, 1024, encryptionKey);\n")),(0,r.kt)("p",{parentName:"li"},"In the listener methods, the code removes the event listener registrations.\nIt then displays a status message indicating whether the database was\ncreated, opened, or whether an error occurred. The most noteworthy part of\nthese event handlers is in the ",(0,r.kt)("inlineCode",{parentName:"p"},"openError()")," method. In that method an ",(0,r.kt)("inlineCode",{parentName:"p"},"if"),"\nstatement checks if the database exists (meaning that the code is attempting\nto connect to an existing database) and if the error ID matches the constant\n",(0,r.kt)("inlineCode",{parentName:"p"},"EncryptionKeyGenerator.ENCRYPTED_DB_PASSWORD_ERROR_ID"),". If both of these\nconditions are true, it probably means that the password the user entered is\nincorrect. (It could also mean that the specified file isn't a database file\nat all.) The following is the code that checks the error ID:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'if (!createNewDB && event.error.errorID == EncryptionKeyGenerator.ENCRYPTED_DB_PASSWORD_ERROR_ID)\n{\n    statusMsg.text = "Incorrect password!";\n}\nelse\n{\n    statusMsg.text = "Error creating or opening database.";\n}\n')),(0,r.kt)("p",{parentName:"li"},"For the complete code for the example event listeners, see\n",(0,r.kt)("a",{parentName:"p",href:"#complete-example-code-for-generating-and-using-an-encryption-key"},"Complete example code for generating and using an encryption key"),"."))),(0,r.kt)("h3",{id:"complete-example-code-for-generating-and-using-an-encryption-key"},"Complete example code for generating and using an encryption key"),(0,r.kt)("p",null,'The following is the complete code for the example application "Generating and\nusing an encryption key." The code consists of two parts.'),(0,r.kt)("p",null,"The example uses the EncryptionKeyGenerator class to create an encryption key\nfrom a password. The EncryptionKeyGenerator class is included in the open-source\nActionScript 3.0 core library (as3corelib) project. You can download\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mikechambers/as3corelib"},"the as3corelib package including source code and documentation"),".\nYou can also download the SWC or source code files from the project page."),(0,r.kt)("h4",{id:"flex-example"},"Flex example"),(0,r.kt)("p",null,"The application MXML file contains the source code for a simple application that\ncreates or opens a connection to an encrypted database:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'<?xml version="1.0" encoding="utf-8"?>\n<mx:WindowedApplication xmlns:mx="https://www.adobe.com/2006/mxml" layout="vertical" creationComplete="init();">\n    <mx:Script>\n    <![CDATA[\n        import com.adobe.air.crypto.EncryptionKeyGenerator;\n\n        private const dbFileName:String = "encryptedDatabase.db";\n\n        private var dbFile:File;\n        private var createNewDB:Boolean = true;\n        private var conn:SQLConnection;\n\n        // ------- Event handling -------\n\n        private function init():void\n        {\n            conn = new SQLConnection();\n            dbFile = File.applicationStorageDirectory.resolvePath(dbFileName);\n            if (dbFile.exists)\n            {\n                createNewDB = false;\n                instructions.text = "Enter your database password to open the encrypted database.";\n                openButton.label = "Open Database";\n            }\n        }\n\n        private function openConnection():void\n        {\n            var password:String = passwordInput.text;\n\n            var keyGenerator:EncryptionKeyGenerator = new EncryptionKeyGenerator();\n\n            if (password == null || password.length <= 0)\n            {\n                statusMsg.text = "Please specify a password.";\n                return;\n            }\n\n            if (!keyGenerator.validateStrongPassword(password))\n            {\n                statusMsg.text = "The password must be 8-32 characters long. It must contain at least one lowercase letter, at least one uppercase letter, and at least one number or symbol.";\n                return;\n            }\n\n            passwordInput.text = "";\n            passwordInput.enabled = false;\n            openButton.enabled = false;\n\n            var encryptionKey:ByteArray = keyGenerator.getEncryptionKey(password);\n\n            conn.addEventListener(SQLEvent.OPEN, openHandler);\n            conn.addEventListener(SQLErrorEvent.ERROR, openError);\n\n            conn.openAsync(dbFile, SQLMode.CREATE, null, false, 1024, encryptionKey);\n        }\n\n        private function openHandler(event:SQLEvent):void\n        {\n            conn.removeEventListener(SQLEvent.OPEN, openHandler);\n            conn.removeEventListener(SQLErrorEvent.ERROR, openError);\n\n            statusMsg.setStyle("color", 0x009900);\n            if (createNewDB)\n            {\n                statusMsg.text = "The encrypted database was created successfully.";\n            }\n            else\n            {\n                statusMsg.text = "The encrypted database was opened successfully.";\n            }\n        }\n\n        private function openError(event:SQLErrorEvent):void\n        {\n            conn.removeEventListener(SQLEvent.OPEN, openHandler);\n            conn.removeEventListener(SQLErrorEvent.ERROR, openError);\n\n            if (!createNewDB && event.error.errorID == EncryptionKeyGenerator.ENCRYPTED_DB_PASSWORD_ERROR_ID)\n            {\n                statusMsg.text = "Incorrect password!";\n            }\n            else\n            {\n                statusMsg.text = "Error creating or opening database.";\n            }\n        }\n    ]]>\n    </mx:Script>\n    <mx:Text id="instructions" text="Enter a password to create an encrypted database. The next time you open the application, you will need to re-enter the password to open the database again." width="75%" height="65"/>\n    <mx:HBox>\n        <mx:TextInput id="passwordInput" displayAsPassword="true"/>\n        <mx:Button id="openButton" label="Create Database" click="openConnection();"/>\n    </mx:HBox>\n    <mx:Text id="statusMsg" color="#990000" width="75%"/>\n</mx:WindowedApplication>\n')),(0,r.kt)("h4",{id:"flash-professional-example"},"Flash Professional example"),(0,r.kt)("p",null,"The application FLA file contains the source code for a simple application that\ncreates or opens a connection to an encrypted database. The FLA file has four\ncomponents placed on the stage:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Instance name"),(0,r.kt)("th",{parentName:"tr",align:null},"Component type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"instructions")),(0,r.kt)("td",{parentName:"tr",align:null},"Label"),(0,r.kt)("td",{parentName:"tr",align:null},"Contains the instructions given to the user")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"passwordInput")),(0,r.kt)("td",{parentName:"tr",align:null},"TextInput"),(0,r.kt)("td",{parentName:"tr",align:null},"Input field where the user enters the password")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"openButton")),(0,r.kt)("td",{parentName:"tr",align:null},"Button"),(0,r.kt)("td",{parentName:"tr",align:null},"Button the user clicks after entering the password")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"statusMsg")),(0,r.kt)("td",{parentName:"tr",align:null},"Label"),(0,r.kt)("td",{parentName:"tr",align:null},"Displays status (success or failure) messages")))),(0,r.kt)("p",null,"The code for the application is defined on a keyframe on frame 1 of the main\ntimeline. The following is the code for the application:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'import com.adobe.air.crypto.EncryptionKeyGenerator;\n\nconst dbFileName:String = "encryptedDatabase.db";\n\nvar dbFile:File;\nvar createNewDB:Boolean = true;\nvar conn:SQLConnection;\n\ninit();\n\n// ------- Event handling -------\n\nfunction init():void\n{\n    passwordInput.displayAsPassword = true;\n    openButton.addEventListener(MouseEvent.CLICK, openConnection);\n    statusMsg.setStyle("textFormat", new TextFormat(null, null, 0x990000));\n\n    conn = new SQLConnection();\n    dbFile = File.applicationStorageDirectory.resolvePath(dbFileName);\n\n    if (dbFile.exists)\n    {\n        createNewDB = false;\n        instructions.text = "Enter your database password to open the encrypted database.";\n        openButton.label = "Open Database";\n    }\n    else\n    {\n        instructions.text = "Enter a password to create an encrypted database. The next time you open the application, you will need to re-enter the password to open the database again.";\n        openButton.label = "Create Database";\n    }\n}\n\nfunction openConnection(event:MouseEvent):void\n{\n    var keyGenerator:EncryptionKeyGenerator = new EncryptionKeyGenerator();\n\n    var password:String = passwordInput.text;\n\n    if (password == null || password.length <= 0)\n    {\n        statusMsg.text = "Please specify a password.";\n        return;\n    }\n\n    if (!keyGenerator.validateStrongPassword(password))\n    {\n        statusMsg.text = "The password must be 8-32 characters long. It must contain at least one lowercase letter, at least one uppercase letter, and at least one number or symbol.";\n        return;\n    }\n\n    passwordInput.text = "";\n    passwordInput.enabled = false;\n    openButton.enabled = false;\n\n    var encryptionKey:ByteArray = keyGenerator.getEncryptionKey(password);\n\n    conn.addEventListener(SQLEvent.OPEN, openHandler);\n    conn.addEventListener(SQLErrorEvent.ERROR, openError);\n\n    conn.openAsync(dbFile, SQLMode.CREATE, null, false, 1024, encryptionKey);\n}\n\nfunction openHandler(event:SQLEvent):void\n{\n    conn.removeEventListener(SQLEvent.OPEN, openHandler);\n    conn.removeEventListener(SQLErrorEvent.ERROR, openError);\n\n    statusMsg.setStyle("textFormat", new TextFormat(null, null, 0x009900));\n    if (createNewDB)\n    {\n        statusMsg.text = "The encrypted database was created successfully.";\n    }\n    else\n    {\n        statusMsg.text = "The encrypted database was opened successfully.";\n    }\n}\n\nfunction openError(event:SQLErrorEvent):void\n{\n    conn.removeEventListener(SQLEvent.OPEN, openHandler);\n    conn.removeEventListener(SQLErrorEvent.ERROR, openError);\n\n    if (!createNewDB && event.error.errorID == EncryptionKeyGenerator.ENCRYPTED_DB_PASSWORD_ERROR_ID)\n    {\n        statusMsg.text = "Incorrect password!";\n    }\n    else\n    {\n        statusMsg.text = "Error creating or opening database.";\n    }\n}\n')),(0,r.kt)("h3",{id:"understanding-the-encryptionkeygenerator-class"},"Understanding the EncryptionKeyGenerator class"),(0,r.kt)("p",null,"It isn't necessary to understand the inner workings of the\nEncryptionKeyGenerator class to use it to create a secure encryption key for\nyour application database. The process for using the class is explained in\n",(0,r.kt)("a",{parentName:"p",href:"#using-the-encryptionkeygenerator-class-to-obtain-a-secure-encryption-key"},"Using the EncryptionKeyGenerator class to obtain a secure encryption key"),".\nHowever, you might find it valuable to understand the techniques that the class\nuses. For example, you might want to adapt the class or incorporate some of its\ntechniques for situations where a different level of data privacy is desired."),(0,r.kt)("p",null,"The EncryptionKeyGenerator class is included in the open-source ActionScript 3.0\ncore library (as3corelib) project. You can download\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mikechambers/as3corelib"},"the as3corelib package including source code and documentation"),".You\ncan also view the source code on the project site or download it to follow along\nwith the explanations."),(0,r.kt)("p",null,"When code creates an EncryptionKeyGenerator instance and calls its\n",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method, several steps are taken to ensure that only the\nrightful user can access the data. The process is the same to generate an\nencryption key from a user-entered password before the database is created as\nwell as to re-create the encryption key to open the database."),(0,r.kt)("h4",{id:"obtain-and-validate-a-strong-password"},"Obtain and validate a strong password"),(0,r.kt)("p",null,"When code calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method, it passes in a password as a\nparameter. The password is used as the basis for the encryption key. By using a\npiece of information that only the user knows, this design ensures that only the\nuser who knows the password can access the data in the database. Even if an\nattacker accesses the user's account on the computer, the attacker can't get\ninto the database without knowing the password. For maximum security, the\napplication never stores the password."),(0,r.kt)("p",null,"An application's code creates an EncryptionKeyGenerator instance and calls its\n",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method, passing a user-entered password as an argument (the\nvariable ",(0,r.kt)("inlineCode",{parentName:"p"},"password")," in this example):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var keyGenerator:EncryptionKeyGenerator = new EncryptionKeyGenerator();\nvar encryptionKey:ByteArray = keyGenerator.getEncryptionKey(password);\n")),(0,r.kt)("p",null,"The first step the EncryptionKeyGenerator class takes when the\n",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method is called is to check the user-entered password to\nensure that it meets the password strength requirements. The\nEncryptionKeyGenerator class requires a password to be 8 - 32 characters long.\nThe password must contain a mix of uppercase and lowercase letters and at least\none number or symbol character."),(0,r.kt)("p",null,"The regular expression that checks this pattern is defined as a constant named\n",(0,r.kt)("inlineCode",{parentName:"p"},"STRONG_PASSWORD_PATTERN"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"private static const STRONG_PASSWORD_PATTERN:RegExp = /(?=^.{8,32}$)((?=.*\\d)|(?=.*\\W+))(?![.\\n])(?=.*[A-Z])(?=.*[a-z]).*$/;\n")),(0,r.kt)("p",null,"The code that checks the password is in the EncryptionKeyGenerator class's\n",(0,r.kt)("inlineCode",{parentName:"p"},"validateStrongPassword()")," method. The code is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"public function vaidateStrongPassword(password:String):Boolean\n{\n    if (password == null || password.length <= 0)\n    {\n        return false;\n    }\n\n    return STRONG_PASSWORD_PATTERN.test(password))\n}\n")),(0,r.kt)("p",null,"Internally the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method calls the EncryptionKeyGenerator\nclass's ",(0,r.kt)("inlineCode",{parentName:"p"},"validateStrongPassword()")," method and, if the password isn't valid,\nthrows an exception. The ",(0,r.kt)("inlineCode",{parentName:"p"},"validateStrongPassword()")," method is a public method so\nthat application code can check a password without calling the\n",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method to avoid causing an error."),(0,r.kt)("h4",{id:"expand-the-password-to-256-bits"},"Expand the password to 256 bits"),(0,r.kt)("p",null,"Later in the process, the password is required to be 256 bits long. Rather than\nrequire each user to enter a password that's exactly 256 bits (32 characters)\nlong, the code creates a longer password by repeating the password characters."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method calls the ",(0,r.kt)("inlineCode",{parentName:"p"},"concatenatePassword()")," method to\nperform the task of creating the long password."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var concatenatedPassword:String = concatenatePassword(password);\n")),(0,r.kt)("p",null,"The following is the code for the ",(0,r.kt)("inlineCode",{parentName:"p"},"concatenatePassword()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'private function concatenatePassword(pwd:String):String\n{\n    var len:int = pwd.length;\n    var targetLength:int = 32;\n\n    if (len == targetLength)\n    {\n        return pwd;\n    }\n\n    var repetitions:int = Math.floor(targetLength / len);\n    var excess:int = targetLength % len;\n\n    var result:String = "";\n\n    for (var i:uint = 0; i < repetitions; i++)\n    {\n        result += pwd;\n    }\n\n    result += pwd.substr(0, excess);\n\n    return result;\n}\n')),(0,r.kt)("p",null,"If the password is less than 256 bits, the code concatenates the password with\nitself to make it 256 bits. If the length doesn't work out exactly, the last\nrepetition is shortened to get exactly 256 bits."),(0,r.kt)("h4",{id:"generate-or-retrieve-a-256-bit-salt-value"},"Generate or retrieve a 256-bit salt value"),(0,r.kt)("p",null,"The next step is to get a 256-bit salt value that in a later step is combined\nwith the password. A ",(0,r.kt)("em",{parentName:"p"},"salt")," is a random value that is added to or combined with\na user-entered value to form a password. Using a salt with a password ensures\nthat even if a user chooses a real word or common term as a password, the\npassword-plus-salt combination that the system uses is a random value. This\nrandomness helps guard against a dictionary attack, where an attacker uses a\nlist of words to attempt to guess a password. In addition, by generating the\nsalt value and storing it in the encrypted local store, it is tied to the user's\naccount on the machine on which the database file is located."),(0,r.kt)("p",null,"If the application is calling the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method for the first\ntime, the code creates a random 256-bit salt value. Otherwise, the code loads\nthe salt value from the encrypted local store."),(0,r.kt)("p",null,"The salt is stored in a variable named ",(0,r.kt)("inlineCode",{parentName:"p"},"salt"),". The code determines if it has\nalready created a salt by attempting to load the salt from the encrypted local\nstore:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var salt:ByteArray = EncryptedLocalStore.getItem(saltKey);\nif (salt == null)\n{\n    salt = makeSalt();\n    EncryptedLocalStore.setItem(saltKey, salt);\n}\n")),(0,r.kt)("p",null,"If the code is creating a new salt value, the ",(0,r.kt)("inlineCode",{parentName:"p"},"makeSalt()")," method generates a\n256-bit random value. Because the value is eventually stored in the encrypted\nlocal store, it is generated as a ByteArray object. The ",(0,r.kt)("inlineCode",{parentName:"p"},"makeSalt()")," method uses\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"Math.random()")," method to randomly generate the value. The ",(0,r.kt)("inlineCode",{parentName:"p"},"Math.random()"),"\nmethod can't generate 256 bits at one time. Instead, the code uses a loop to\ncall ",(0,r.kt)("inlineCode",{parentName:"p"},"Math.random()")," eight times. Each time, a random uint value between 0 and\n4294967295 (the maximum uint value) is generated. A uint value is used for\nconvenience, because a uint uses exactly 32 bits. By writing eight uint values\ninto the ByteArray, a 256-bit value is generated. The following is the code for\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"makeSalt()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"private function makeSalt():ByteArray\n{\n    var result:ByteArray = new ByteArray;\n\n    for (var i:uint = 0; i < 8; i++)\n    {\n        result.writeUnsignedInt(Math.round(Math.random() * uint.MAX_VALUE));\n    }\n\n    return result;\n}\n")),(0,r.kt)("p",null,"When the code is saving the salt to the Encrypted Local Store (ELS) or\nretrieving the salt from the ELS, it needs a String key under which the salt is\nsaved. Without knowing the key, the salt value can't be retrieved. In that case,\nthe encryption key can't be re-created each time to reopen the database. By\ndefault, the EncryptionKeyGenerator uses a predefined ELS key that is defined in\nthe constant ",(0,r.kt)("inlineCode",{parentName:"p"},"SALT_ELS_KEY"),". Instead of using the default key, application code\ncan also specify an ELS key to use in the call to the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()"),"\nmethod. Either the default or the application-specified salt ELS key is stored\nin a variable named ",(0,r.kt)("inlineCode",{parentName:"p"},"saltKey"),". That variable is used in the calls to\n",(0,r.kt)("inlineCode",{parentName:"p"},"EncryptedLocalStore.setItem()")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"EncryptedLocalStore.getItem()"),", as shown\npreviously."),(0,r.kt)("h4",{id:"combine-the-256-bit-password-and-salt-using-the-xor-operator"},"Combine the 256-bit password and salt using the XOR operator"),(0,r.kt)("p",null,"The code now has a 256-bit password and a 256-bit salt value. It next uses a\nbitwise XOR operation to combine the salt and the concatenated password into a\nsingle value. In effect, this technique creates a 256-bit password consisting of\ncharacters from the entire range of possible characters. This principle is true\neven though most likely the actual password input consists of primarily\nalphanumeric characters. This increased randomness provides the benefit of\nmaking the set of possible passwords large without requiring the user to enter a\nlong complex password."),(0,r.kt)("p",null,"The result of the XOR operation is stored in the variable ",(0,r.kt)("inlineCode",{parentName:"p"},"unhashedKey"),". The\nactual process of performing a bitwise XOR on the two values happens in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"xorBytes()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var unhashedKey:ByteArray = xorBytes(concatenatedPassword, salt);\n")),(0,r.kt)("p",null,"The bitwise XOR operator ( ",(0,r.kt)("inlineCode",{parentName:"p"},"^"),") takes two uint values and returns a uint value.\n(A uint value contains 32 bits.) The input values passed as arguments to the\n",(0,r.kt)("inlineCode",{parentName:"p"},"xorBytes()")," method are a String (the password) and a ByteArray (the salt).\nConsequently, the code uses a loop to extract 32 bits at a time from each input\nto combine using the XOR operator."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"private function xorBytes(passwordString:String, salt:ByteArray):ByteArray\n{\n    var result:ByteArray = new ByteArray();\n\n    for (var i:uint = 0; i < 32; i += 4)\n    {\n        // ...\n    }\n\n    return result;\n}\n")),(0,r.kt)("p",null,"Within the loop, first 32 bits (4 bytes) are extracted from the ",(0,r.kt)("inlineCode",{parentName:"p"},"passwordString"),"\nparameter. Those bits are extracted and converted into a uint ( ",(0,r.kt)("inlineCode",{parentName:"p"},"o1"),") in a\ntwo-part process. First, the ",(0,r.kt)("inlineCode",{parentName:"p"},"charCodeAt()")," method gets each character's numeric\nvalue. Next, that value is shifted to the appropriate position in the uint using\nthe bitwise left shift operator ( ",(0,r.kt)("inlineCode",{parentName:"p"},"<<"),") and the shifted value is added to ",(0,r.kt)("inlineCode",{parentName:"p"},"o1"),".\nFor example, the first character ( ",(0,r.kt)("inlineCode",{parentName:"p"},"i"),") becomes the first 8 bits by using the\nbitwise left shift operator ( ",(0,r.kt)("inlineCode",{parentName:"p"},"<<"),") to shift the bits left by 24 bits and\nassigning that value to ",(0,r.kt)("inlineCode",{parentName:"p"},"o1"),". The second character ",(0,r.kt)("inlineCode",{parentName:"p"},"(i + 1"),") becomes the second\n8 bits by shifting its value left 16 bits and adding the result to ",(0,r.kt)("inlineCode",{parentName:"p"},"o1"),". The\nthird and fourth characters' values are added the same way."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    // ...\n\n    // Extract 4 bytes from the password string and convert to a uint\n    var o1:uint = passwordString.charCodeAt(i) << 24;\n    o1 += passwordString.charCodeAt(i + 1) << 16;\n    o1 += passwordString.charCodeAt(i + 2) << 8;\n    o1 += passwordString.charCodeAt(i + 3);\n\n    // ...\n")),(0,r.kt)("p",null,"The variable ",(0,r.kt)("inlineCode",{parentName:"p"},"o1")," now contains 32 bits from the ",(0,r.kt)("inlineCode",{parentName:"p"},"passwordString")," parameter.\nNext, 32 bits are extracted from the ",(0,r.kt)("inlineCode",{parentName:"p"},"salt")," parameter by calling its\n",(0,r.kt)("inlineCode",{parentName:"p"},"readUnsignedInt()")," method. The 32 bits are stored in the uint variable ",(0,r.kt)("inlineCode",{parentName:"p"},"o2"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    // ...\n\n    salt.position = i;\n    var o2:uint = salt.readUnsignedInt();\n\n    // ...\n")),(0,r.kt)("p",null,"Finally, the two 32-bit (uint) values are combined using the XOR operator and\nthe result is written into a ByteArray named ",(0,r.kt)("inlineCode",{parentName:"p"},"result"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    // ...\n\n    var xor:uint = o1 ^ o2;\n    result.writeUnsignedInt(xor);\n    // ...\n")),(0,r.kt)("p",null,"Once the loop completes, the ByteArray containing the XOR result is returned."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"            // ...\n    }\n\n    return result;\n}\n")),(0,r.kt)("h4",{id:"hash-the-key"},"Hash the key"),(0,r.kt)("p",null,"Once the concatenated password and the salt have been combined, the next step is\nto further secure this value by hashing it using the SHA-256 hashing algorithm.\nHashing the value makes it more difficult for an attacker to reverse-engineer\nit."),(0,r.kt)("p",null,"At this point the code has a ByteArray named ",(0,r.kt)("inlineCode",{parentName:"p"},"unhashedKey")," containing the\nconcatenated password combined with the salt. The ActionScript 3.0 core library\n(as3corelib) project includes a SHA256 class in the com.adobe.crypto package.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"SHA256.hashBytes()")," method that performs a SHA-256 hash on a ByteArray and\nreturns a String containing the 256-bit hash result as a hexadecimal number. The\nEncryptionKeyGenerator class uses the SHA256 class to hash the key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var hashedKey:String = SHA256.hashBytes(unhashedKey);\n")),(0,r.kt)("h4",{id:"extract-the-encryption-key-from-the-hash"},"Extract the encryption key from the hash"),(0,r.kt)("p",null,"The encryption key must be a ByteArray that is exactly 16 bytes (128 bits) long.\nThe result of the SHA-256 hashing algorithm is always 256 bits long.\nConsequently, the final step is to select 128 bits from the hashed result to use\nas the actual encryption key."),(0,r.kt)("p",null,"In the EncryptionKeyGenerator class, the code reduces the key to 128 bits by\ncalling the ",(0,r.kt)("inlineCode",{parentName:"p"},"generateEncryptionKey()")," method. It then returns that method's\nresult as the result of the ",(0,r.kt)("inlineCode",{parentName:"p"},"getEncryptionKey()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"var encryptionKey:ByteArray = generateEncryptionKey(hashedKey);\nreturn encryptionKey;\n")),(0,r.kt)("p",null,"It isn't necessary to use the first 128 bits as the encryption key. You could\nselect a range of bits starting at some arbitrary point, you could select every\nother bit, or use some other way of selecting bits. The important thing is that\nthe code selects 128 distinct bits, and that the same 128 bits are used each\ntime."),(0,r.kt)("p",null,"In this case, the ",(0,r.kt)("inlineCode",{parentName:"p"},"generateEncryptionKey()")," method uses the range of bits\nstarting at the 18th byte as the encryption key. As mentioned previously, the\nSHA256 class returns a String containing a 256-bit hash as a hexadecimal number.\nA single block of 128 bits has too many bytes to add to a ByteArray at one time.\nConsequently, the code uses a ",(0,r.kt)("inlineCode",{parentName:"p"},"for")," loop to extract characters from the\nhexadecimal String, convert them to actual numeric values, and add them to the\nByteArray. The SHA-256 result String is 64 characters long. A range of 128 bits\nequals 32 characters in the String, and each character represents 4 bits. The\nsmallest increment of data you can add to a ByteArray is one byte (8 bits),\nwhich is equivalent to two characters in the ",(0,r.kt)("inlineCode",{parentName:"p"},"hash")," String. Consequently, the\nloop counts from 0 to 31 (32 characters) in increments of 2 characters."),(0,r.kt)("p",null,"Within the loop, the code first determines the starting position for the current\npair of characters. Since the desired range starts at the character at index\nposition 17 (the 18th byte), the ",(0,r.kt)("inlineCode",{parentName:"p"},"position")," variable is assigned the current\niterator value ( ",(0,r.kt)("inlineCode",{parentName:"p"},"i"),") plus 17. The code uses the String object's ",(0,r.kt)("inlineCode",{parentName:"p"},"substr()"),"\nmethod to extract the two characters at the current position. Those characters\nare stored in the variable ",(0,r.kt)("inlineCode",{parentName:"p"},"hex"),". Next, the code uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"parseInt()")," method to\nconvert the ",(0,r.kt)("inlineCode",{parentName:"p"},"hex")," String to a decimal integer value. It stores that value in the\nint variable ",(0,r.kt)("inlineCode",{parentName:"p"},"byte"),". Finally, the code adds the value in ",(0,r.kt)("inlineCode",{parentName:"p"},"byte")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"result"),"\nByteArray using its ",(0,r.kt)("inlineCode",{parentName:"p"},"writeByte()")," method. When the loop finishes, the ",(0,r.kt)("inlineCode",{parentName:"p"},"result"),"\nByteArray contains 16 bytes and is ready to use as a database encryption key."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"private function generateEncryptionKey(hash:String):ByteArray\n{\n    var result:ByteArray = new ByteArray();\n\n    for (var i:uint = 0; i < 32; i += 2)\n    {\n        var position:uint = i + 17;\n        var hex:String = hash.substr(position, 2);\n        var byte:int = parseInt(hex, 16);\n        result.writeByte(byte);\n    }\n\n    return result;\n}\n")))}h.isMDXComponent=!0}}]);